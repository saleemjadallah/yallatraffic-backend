// Yalla Backend - Prisma Schema
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION (Apple Sign In)
// ============================================

model User {
  id            String   @id @default(cuid())
  appleUserId   String   @unique  // Apple's unique user identifier
  email         String?  @unique
  displayName   String?
  givenName     String?
  familyName    String?
  photoUrl      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLoginAt   DateTime @default(now())

  // Relations
  savedPlaces   SavedPlace[]
  trips         Trip[]
  incidents     Incident[]
  preferences   UserPreferences?
  pushTokens    PushToken[]
  vibes         Vibe[]

  @@index([appleUserId])
}

model UserPreferences {
  id                    String   @id @default(cuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Route preferences
  avoidTolls            Boolean  @default(false)
  avoidHighways         Boolean  @default(false)
  preferredRouteType    String   @default("fastest") // fastest, shortest, eco

  // Notification preferences
  notificationsEnabled  Boolean  @default(true)
  departureAlerts       Boolean  @default(true)
  trafficAlerts         Boolean  @default(true)
  incidentAlerts        Boolean  @default(true)
  weeklyDigest          Boolean  @default(true)
  commuteReminderMinutes Int     @default(15)

  // Display preferences
  distanceUnit          String   @default("km") // km, mi
  timeFormat            String   @default("24h") // 12h, 24h
  language              String   @default("en") // en, ar

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// ============================================
// SAVED PLACES
// ============================================

model SavedPlace {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name          String
  address       String?
  latitude      Float
  longitude     Float
  placeType     String   @default("other") // home, work, other
  icon          String?  // emoji or icon name

  // For frequent destinations tracking
  visitCount    Int      @default(0)
  lastVisited   DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([userId, placeType])
}

// ============================================
// TRIP HISTORY
// ============================================

model Trip {
  id                  String   @id @default(cuid())
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Origin
  originName          String?
  originAddress       String?
  originLat           Float
  originLng           Float

  // Destination
  destinationName     String?
  destinationAddress  String?
  destinationLat      Float
  destinationLng      Float

  // Trip details
  departureTime       DateTime
  arrivalTime         DateTime?
  distanceMeters      Int
  durationSeconds     Int
  delaySeconds        Int      @default(0)

  // Comparison with typical
  typicalDuration     Int?     // seconds
  timeSavedSeconds    Int?     // positive = saved time, negative = lost time

  // Trip score (gamification)
  tripScore           Int?     // 0-100

  // Route info (stored as JSON for flexibility)
  routePolyline       String?  // encoded polyline
  trafficConditions   String?  // JSON: traffic breakdown

  createdAt           DateTime @default(now())

  @@index([userId])
  @@index([userId, departureTime])
  @@index([departureTime])
}

// ============================================
// COMMUNITY INCIDENTS
// ============================================

model Incident {
  id              String   @id @default(cuid())
  reportedBy      String?
  reporter        User?    @relation(fields: [reportedBy], references: [id], onDelete: SetNull)

  // Location
  latitude        Float
  longitude       Float
  roadName        String?

  // Incident details
  type            String   // accident, hazard, police, roadwork, congestion, other
  severity        String   @default("moderate") // minor, moderate, major
  description     String?

  // Verification
  confirmations   Int      @default(1)
  denials         Int      @default(0)
  isVerified      Boolean  @default(false)

  // Timing
  reportedAt      DateTime @default(now())
  expiresAt       DateTime
  resolvedAt      DateTime?
  isActive        Boolean  @default(true)

  // Votes tracking
  votes           IncidentVote[]

  @@index([latitude, longitude])
  @@index([isActive, expiresAt])
  @@index([type, isActive])
}

model IncidentVote {
  id          String   @id @default(cuid())
  incidentId  String
  incident    Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)


  voterIp     String?  // For anonymous votes (hashed)
  voteType    String   // confirm, deny

  createdAt   DateTime @default(now())

  @@unique([incidentId, voterIp])
  @@index([incidentId])
}

// ============================================
// COMMUNITY VIBES
// ============================================

model Vibe {
  id          String   @id @default(cuid())

  // Anonymous user ID (no account needed)
  anonymousId String

  // Optionally linked to account
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Location
  latitude    Float
  longitude   Float
  geohash     String   // For efficient geo queries
  segmentId   String   // Road segment identifier

  // Vibe type
  type        String   // smooth, slowdown, heavy, deadlock, accident, police, hazard

  // Timing
  createdAt   DateTime @default(now())
  expiresAt   DateTime // Usually 7 minutes from creation

  @@index([segmentId, expiresAt])
  @@index([geohash])
  @@index([anonymousId, createdAt])
  @@index([expiresAt])
}

// Aggregated vibe clusters for efficient queries
model VibeCluster {
  id            String   @id @default(cuid())
  segmentId     String   @unique

  // Location (center of segment)
  latitude      Float
  longitude     Float
  geohash       String

  // Aggregated counts by type
  smoothCount     Int    @default(0)
  slowdownCount   Int    @default(0)
  heavyCount      Int    @default(0)
  deadlockCount   Int    @default(0)
  accidentCount   Int    @default(0)
  policeCount     Int    @default(0)
  hazardCount     Int    @default(0)

  totalCount      Int    @default(0)
  dominantVibe    String @default("smooth")

  lastUpdated   DateTime @default(now())
  expiresAt     DateTime

  @@index([geohash])
  @@index([expiresAt])
}

// Rate limiting for vibe submissions
model VibeRateLimit {
  id            String   @id @default(cuid())
  anonymousId   String   @unique

  lastVibeAt    DateTime
  vibeCount24h  Int      @default(1)
  resetAt       DateTime // When 24h count resets

  @@index([anonymousId])
}

// ============================================
// PUSH NOTIFICATIONS (APNs)
// ============================================

model PushToken {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  token       String   // APNs device token
  platform    String   @default("ios") // ios only for now
  deviceId    String?
  bundleId    String?  // App bundle ID

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, token])
  @@index([userId, isActive])
}

// ============================================
// SCHEDULED NOTIFICATIONS (for departure alerts)
// ============================================

model ScheduledAlert {
  id              String   @id @default(cuid())
  userId          String

  // Trip info
  destinationName String
  destinationLat  Float
  destinationLng  Float

  // Schedule
  scheduledFor    DateTime // When to send the alert
  eventTime       DateTime // When the event/meeting starts

  // Status
  status          String   @default("pending") // pending, sent, cancelled
  sentAt          DateTime?

  createdAt       DateTime @default(now())

  @@index([status, scheduledFor])
  @@index([userId])
}
